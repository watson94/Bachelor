%-*-coding: utf-8-*-
\chapter{Решение массовой задачи о ближайшем отрезке с использованием квадродерева}
\section{Квадродерево}
Квадродерево -- поисковая структура данных, которая хранит в себе
подразбиение плоскости и позволяет быстро производить локализацию
точек-запросов. Узел (ячейка) квадродерева представляет собой прямоугольник, для
которого определена некоторая мера его насыщенности $p(C)$. Если узел
насыщен ($p(C) > T$, где $T$ -- предельное насыщение), то происходит его
разбиение на четыре одинаковых дочерних узла (делением пополам по
вертикали и по горизонтали). Таким образом, в каждый момент времени у узла
или нет детей или их четыре. Разбиение происходит до тех пор, пока все узлы
не перестанут быть насыщенными, или не будет достигнута максимальная
глубина подразбиения. Ограничение глубины подразбиения играет важную
роль в виду того, что не всегда получается сделать узел ненасыщенным за
конечное (или разумное) количество разбиений, далее будет дано более 
точное обоснование необходимости ограничения.

Квадродеревья и их модификации очень часто применяют для решения
задач примерного поиска ближайшего соседа (Approximate Nearest Neighbor
Search) для точек \cite{FANN} (рис. \ref{ann}). В качестве меры насыщения в этой задаче часто
выбирают количество точек, среди которых производится поиск, попавших в
ячейку. В насыщенность обычно ограничивают одной точкой в одной ячейке.
Максимальная глубина древа для $n$ точек может составлять $n$, в результате чего
время локализации может составлять $O(n)$. Для борьбы с этим была разработана
структура данных Skip-Quadtree \cite{SQT}, которая позволяет производить локализацию за $O(\log n)$.

\drawfigurex{ann}{Квадродерево}{ann}{width=5cm}

Квадродерево обладает свойствами, которые делают его предпочтительным
для решения задачи dist2segments, по сравнению с другими деревьями.
Например, квадродерево не требует наличия логики, по которой будет происходить
разбиение ячейки (в отличии от kd-дерева). Разбиение всегда происходит на четыре
равные ячейки. Также важным свойством является быстрота локализации точки в нем.
За счет того, что квадродерево имеет регулярную структуру, можно по координатам точки
и глубине сразу получить путь в квадродереве. Более того, в виду замечательного
слвпадения, можно за несколько операций над числами с плавающей точкой по координате точки получить путь
до листа. Остановимся на это поподробнее.

Рассмотрим устройство чисел с плавающей точкой. Они состоят из знака $s$, мантиссы $m$ 
и экспоненты $e$, причем $m \in [1, 2)$ и первая единица не хранится. Само число 
представляется в виде $sm2^e$. В компьютерном представлении экспонента хранится в виде
двоичной последовательности $b_1b_2\ldots b_n$, при этом $m = 1 + \sum\limits_{i=1}^nb_i2^{-i}$.

Теперь вернемся к квадродереву. Пусть $(x_0, y_0)$ -- координаты левого нижнего угла первого уровня квадродерева, 
а $w, h$ -- его ширина и высота. Перейдем в новую систему координат.\\
$
\left\{
\begin{array}{l}
x' = (x - x_0)/w  \\
y' = (y - y_0)/h  \\
\end{array}
\right.$

В этой системе координат внутренние точки квадродерева имеют координаты
$(x', y') \in [0, 1] \times [0, 1]$. Посмотрим, что происходит при переходе на уровень вниз.
В системе координат ячейки ее дети имеют координаты $[0, \frac{1}{2}] \times [0, \frac{1}{2}]$
-- левый нижний, $[\frac{1}{2}, 1] \times [0, \frac{1}{2}]$
-- правый нижний, $[0, \frac{1}{2}] \times [\frac{1}{2}, 1]$
-- левый верхний, $[\frac{1}{2}, 1] \times [\frac{1}{2}, 1]$
-- правый верхний. Опишем переход в систему координат ребенка.\\
$
\left\{
\begin{array}{l}
x_{i+1} = 2(x_i - x_{c_i})  \\
y_{i+1} = 2(y_i - y_{c_i})  \\
\end{array}
\right.$
\\

Заменим координаты левых нижних углов детей $(x_{c_i}, y_{c_i}) \in \{0, \frac{1}{2}\} \times \{0, \frac{1}{2}\}$
на $(b^x_{c_i}, b^y_{c_i}) = (2x_{c_i}, 2y_{c_i}) \in \{0, 1\} \times \{0, 1\}$.\\
$
\left\{
\begin{array}{l}
x_{i+1} = 2x_i - b^x_{c_i}  \\
y_{i+1} = 2y_i - b^y_{c_i}  \\
\end{array}
\right.$
\\
Теперь посмотрим на обратный переход.\\
$
\left\{
\begin{array}{l}
x_i = \frac{1}{2}(b^x_{c_i} + x_{i+1})  \\
y_i = \frac{1}{2}(b^y_{c_i} + y_{i+1})  \\
\end{array}
\right.$
\\
Найдем формулу перехода от уровня $d$ к самому верхнему уровню.\\
$
\left\{
\begin{array}{l}
x_1 = \sum\limits_{i=1}^db^x_{c_i}2^{-i} + x_d  \\
y_1 = \sum\limits_{i=1}^db^y_{c_i}2^{-i} + y_d  \\
\end{array}
\right.$
\\
Что по сути является двочным представлением координат точки в системе координат вехней ячейки квадродерева.
То есть, совершив преобразовние координат, мы получаем путь в квадродереве в виде битов
двоичного представления координат.

Эта техника позволяет производить быструю локализацию в квадродереве. 
Специальной обработки требует только экспонента. Также неоценимым достоинством этого метода
является его робастность. Если аккуратно произвести преобразование координат мы можем
получить путь на глубину $d = 53$ для чисел с плавющей точкой двойной точности.

\FloatBarrier
\section{Нижняя огибающая}
Неформально нижняя огибающая (lower envelope) множества объектов на плоскости –
множество точек этих объектов, видимые наблюдателем, расположенным в
точке $(0, -\infty)$. Формально же это граф, представляющий из себя поточечный
минимум кусочно-заданных функций \cite{LENV} (рис. \ref{lenv}).
Также наряду с нижней огибающей часто рассматривается минимизационная диаграмма
(minimization diagram), которая представляет собой проекцию нижней огибающей на
горизонтальную ось (рис. \ref{mdiag}). 
\drawfigure{lenv}{Нижняя огибающая}{lenv}
\drawfigure{mdiag}{Минимизационная диаграмма}{mdiag}

\FloatBarrier
\section{Алгоритм}
\subsection{Идея алгоритма}
Основной идеей всех алгоритмов поиска ближайших сайтов (sites),
основанных на подразбиении пространства, является растеризация (с явным
построением или без него) диаграммы Вороного в этом подразбиении. После
этого в ячейках подразбиения оказывается информация, обо всех ближайших
сайтов для всех точек этой ячейки. Поиск ближайшего сайта происходит
путем локализации в этом подразбиении и последующим перебором всех
сайтов, ближайших к найденной ячейке.

В виду нетривиальности задачи поиска всех сайтов ближайших к ячейке,
во многих алгоритмах переходят к примерному решению задачи поиска
ближайшего отрезка \cite{NGRID}, производя поиск сайтов, ближайших к каким-то
точкам ячейки. Точки обычно выбираются таким образом, чтобы обеспечить
заданную точность, но в некоторых случаях даже не идет речи о точности \cite{AVOR}.
Для некоторых случаев погрешность допустима, но робастность (robustness)
является важной характеристикой алгоритмов вычислительной геометрии \cite{ROBUS}.
Предложенный алгоритм позволяет произвести точный поиск ближайших
отрезков для ячеек, при условии, что можно явно (хотя бы кусочно) задать
расстояние от границ ячеек до отрезков в виде полинома.

\FloatBarrier
\subsection{Работа алгоритма}

Для отрезков строится ограничивающий прямоугольник (bounding box), этот прямоугольник будет первым
уровнем квадродерева. В качестве меры насыщенности узла берется количество
ближайших отрезков к данной ячейке. Для первого узла ближайшими будут все
отрезки, так как они все лежат внутри. Далее происходит рекурсивное
подразбиение узлов. Ближайшими к дочернему узлу будут отрезки ближайшие
к его родителю, так как дочерний узел геометрически лежит внутри
родительского. Необходимо произвести фильтрацию лишних отрезков.

{\prop\label{cl_segs}
Ближайшие отрезки для точек ячейки -- это отрезки ближайшие к ее границе и отрезки пересекающие ячейку}
\begin{proof}
Обозначим: $S$ -- множество отрезков, ближайших к ячейке, $S_b$ -- ближайших к границе, $S_i$ --
пересекающих ячейку.
\begin{itemize}
\item $S_b \cup S_i \subset S$ \\
$S_b \subset S$ -- очевидно, так как граница ячейки -- это ее подмножество.\\
Для любой точки на пересечении отрезка и ячейки этот отрезок будет
ближайшим, значит $S_i \subset S$
\item $S_b \cup S_i \supset S$ \\
Предположим, что это не так.\\Пусть $s$ -- отрезок, не пересекающий
ячейку, и он не является ближайшим ни к одной точке на границе. Пусть
он ближайший для точки $P$ ячейки, а $Q$ -- точка $s$, ближайшая к $P$.
Построим отрезок $PQ$, так точка $P$ вне ячейки, а точка $Q$ внутри, то $PQ$
пересечет границу ячейки, допустим в точке $F$. Рассмотрим отрезок $s'$,
ближайший к $F$. Пусть точка $E$ -- ближайшая точка на нем к $F$.
Так как $s'$ ближайший к $F$, то $|FE| < |FQ|$, по неравенству треугольника $|PF|
+ |FE| < |PE|$. Подставив первое неравенство во второе, мы получим, что
отрезок $s'$ ближе к $P$ чем $s$ (рис. \ref{contrex}).\\
Противоречие.
\end{itemize}
$\qedsymbol$
\drawfigure{contrex}{Противоречие}{contrex}
\end{proof}

Это простое утверждение показывает, что для фильтрации нам
необходимо взять из отрезков только те, которые являются ближайшими для
границы ячейки, и те, которые ее пересекают.
Для поиска отрезков ближайших к границе ячейки для каждой стороны
прямоугольника строится нижняя огибающая функций кратчайшего расстояния от
стороны до отрезков, которые фильтруются (рис. \ref{le_dist}).

Функция кратчайшего расстояния до отрезка состоит из трех частей: двух функции расстояния от
стороны до концов отрезка, и функции расстояния от стороны до прямой,
содержащей отрезок этот, заданной на ограниченном промежутке. В результате
из нижней огибающей можно выделить информацию об отрезках ближайших к
сторонам ячейки. Также эта фильтрация оставляет отрезки, пересекающие
границу. Значит, к полученным отрезкам остается только добавить отрезки
лежащие внутри ячейки. Для проверки этого условия достаточно проверить
принадлежность одной из точек отрезка ячейке.

\drawfigurex{le_dist}{Нижняя огибающа функций кратчайших расстояний}{le_dist}{width=6cm}

Подразбиение будет происходить до тех пор, пока все ячейки не
перестанут быть насыщенными, или пока не будет достигнута максимальная
глубина подразбиения. В данной задаче очень важно ограничить глубину
подразбиения, так как в вырожденных случаях (degenerate cases) некоторые
ячейки поразбить не получится. Вырожденным случаем для диаграммы
Вороного является наличие четырех и более сайтов равноудаленных от одной
точки. В таком случае в этой точке получается вершина диаграммы Вороного,
граничащая с ячейками соответствующих сайтов. В результате наличия
большого числа сайтов расположенных таким образом (пусть их $n$), ячейка
квадродерева, содержащая эту точку, будет ближайшей как минимум к $n$
сайтам. Разбив такую ячейку мы все равно получим одну ячейку содержащую
эту вершину диаграммы Вороного. Поэтому имеет смысл ограничивать
глубину разбиения.
Итак, в результате получается квадродерево, в листьях которого лежит
информация о ближайших к ним отрезках. Поиск ближайшего отрезка по такой
структуре данных осуществляется в два этапа. Сначала происходит
локализация точки-запроса в квадродереве. Затем перебираются все отрезки,
ближайшие к найденной ячейке, и среди них выбирается ближайший.

\FloatBarrier
\subsection{Оценка числа перебираемых отрезков}
Скорость обработки запроса очень сильно зависит от числа отрезков в ячейке.
Рассмотрим равномерное распределение точек-запросов на прямоугольнике,
задаваемом верхним уровнем квадродерева. Пусть $X$ -- случайный запрос, 
$n(X)$ -- число перебираемых отрезков, при запросе $X$, $C$ -- прямоугольник, 
покрываемый верхним уровнем квадродерева, $L$ -- множество листьев квадродерева.
\begin{equation}
E\{n(X)\} = \int\limits_Cn(X)dp(X) =  \sum\limits_{l \in L}n_lp_l
\end{equation}
Так как распределение равномерное, то $p_l = \frac{S_l}{S}$, где 
$S_l$ -- площадь листа $l$, $S$ -- площадь покрываемая квадродеревом.
В итоге получаем простую формулу.
\begin{equation}
E\{n(X)\} = \frac{1}{S}\sum\limits_{l \in L}n_lS_l
\end{equation}

Попытаемся оценить эту величину сверху. Пусть губина дерева ограничена числом $d$, 
а $c$ -- насыщенность узла квадродерева, после которой он разбивается.
Заметим, что листья бывают двух видов: насыщенные и ненасыщенные. Насыщенные листья -- это
листья, которые находятся на уровне $d$ и все еще содержат больше, чем $c$ отрезков.
Обозначим множество ненасыщенных листьев $G$ (good), множество насыщенных листьев $B$ (bad).
\begin{equation}
E\{n(X)\} = \frac{1}{S}\sum\limits_{l \in L}n_lS_l = 
\label{expectation}
\frac{1}{S}\sum\limits_{l \in G}n_lS_l 
+
\frac{1}{S}\sum\limits_{l \in B}n_lS_l
\end{equation}
Оценим первую сумму.
\begin{equation}
\frac{1}{S}\sum\limits_{l \in G}n_lS_l \le \frac{c}{S}\sum\limits_{l \in G}S_l \le \frac{c}{S}S = c
\label{sum1}
\end{equation}
Оценим вторую сумму. Так как листья из $B$ находятся на уровне $d$, то $S_l = \frac{S}{4^d}$.
В каждом таком листе не более $n$ отрезков.
\begin{equation}
\frac{1}{S}\sum\limits_{l \in B}n_lS_l \le \frac{Sn}{4^dS}|B| = \frac{n|B|}{4^d}
\label{sum2}
\end{equation}
Осталось оценить мощность множества $B$. Ячейка попадает в множество $B$, если ее пересекает
большое число ячеек диаграммы Вороного исходного множества отрезков.
Это возможно в случае попадания туда вершины диаграммы Вороного большой степени (рис. \ref{big_deg})
или пересечения большим числом узких локусов (рис. \ref{thin_loc}). Вершин в диаграмме Вороного
$O(n)$, локусов тоже $O(n)$. 

\drawfigurex{big_deg}{Вершина диаграммы Вороного большой степени}{big_deg}{width=5cm}
\drawfigurex{thin_loc}{Узкие локусы}{thin_loc}{width=5cm}
\FloatBarrier

Рассмотрим подразбиение прямоугольника, покрываемого верхним уровнем 
диаграммы Вороного, на $4^d$ ячеек ($2^d$ по вертикали и горизонтали).
Границы ячеек диаграммы Вороного представляют из себя отрезки прямых и парабол, следовательно
узкие ячейки растеризуются в этой сетке как отрезки или параболы, а не как площадные объекты, 
так как они уже ячеек сетки. При растеризации в сетку параболы и отрезки пересекают $O(n)$ ячеек (сетка $n \times n$).
Следовательно узкий локус пересекает $O(2^d)$ ячеек. Можно оценить $|B|$.
\begin{equation}
|B| = O(n2^d)
\label{bad_segs}
\end{equation}

Сводя все воедино, получаем верхнюю оценку математического ожидания числа перебираемых отрезков.
\begin{equation}
E\{n(X)\} = c + \frac{nO(n2^d)}{4^d} = c + \frac{O(n^2)}{2^d}
\end{equation}

Отсюда видно, что при $d = 2\log_2 n + C$, где $C$ -- константа, $E\{n(X)\} = O(1)$.

\FloatBarrier
\subsection{Анализ полученных результатов}
Если произвести грубую оценку времени построения квадродерева для
этой задачи, то получается, что оно ограничено только максимальной глубиной
подразбиения. Это так, но на практике построение происходит достаточно
быстро, в виду того, что сильное подразбиение испытывают в основном
области, содержащие вершины и узкие локусы диаграммы Вороного. 
Максимально возможное число ячеек будет $4^d$, что равно $O(n^4)$.

Время поиска ближайшего отрезка складывается из времени
локализации и времени поиска ближайшего отрезка среди ближайших к
ячейке. Тогда как первая величина ограничена сверху $d$, вторая ограничивается
только количеством отрезков (достаточно вспомнить вырожденный случай).
Ввиду того что $d$ обычно не очень велико и локализация в дереве, как
было показано, не требует на каждом шаге операций с плавающей точкой, 
а происходит простой спуск по заданному пути, основной вклад во время 
поиска ближайшего вносит перебор отрезков из ячейки.
Хоть локализация и занимает $O(\log n)$ времени, но, по уже оговоренным причинам,
алгоритм на разумном числе отрезков оказался очень эффективным, в виду того,
что математическое ожидание перебираемых отрезков $O(1)$. Практические данные
показывают, что эта величина примерно равна $0,5c ÷ c$, где $c$ -- предельная
насыщенность ячейки. 

В следующей главе будет приведено сравнение
квадродерева с n-grid \cite{NGRID} и SVD \cite{CGAL}.
Максимальное количество занимаемой памяти можно грубо оценить, как
$O(2^d n + 4^d) = O(n^4)$, что на практике не наблюдается.

\FloatBarrier
